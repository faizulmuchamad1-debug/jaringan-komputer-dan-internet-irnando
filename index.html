<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Switch Jaringan Sederhana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        #networkCanvas {
            border: 2px solid #3b82f6;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .control-panel {
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            width: 95%;
            margin-top: 1rem;
        }
    </style>
</head>
<body>

    <h1 class="text-2xl font-bold text-gray-800 mb-4">Simulasi Switching Jaringan (LAN)</h1>
    <p class="text-sm text-gray-600 mb-4 text-center">Demonstrasi bagaimana *Switch* mengirim paket data.</p>

    <!-- Canvas untuk Visualisasi Jaringan -->
    <canvas id="networkCanvas" width="360" height="360" class="w-full max-w-lg"></canvas>

    <!-- Panel Kontrol -->
    <div class="control-panel flex flex-col space-y-4">
        <div id="message-box" class="min-h-[2rem] p-2 text-sm font-medium text-center rounded-md bg-blue-100 text-blue-700">
            Pilih perangkat asal dan tujuan, lalu kirim paket!
        </div>

        <div class="flex flex-col sm:flex-row justify-between space-y-3 sm:space-y-0 sm:space-x-3">
            <!-- Pilihan Perangkat Asal -->
            <div class="flex-1">
                <label for="sourceDevice" class="block text-sm font-medium text-gray-700">Perangkat Asal:</label>
                <select id="sourceDevice" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="PC1">PC 1 (192.168.1.1)</option>
                    <option value="PC2">PC 2 (192.168.1.2)</option>
                    <option value="PC3">PC 3 (192.168.1.3)</option>
                </select>
            </div>

            <!-- Pilihan Perangkat Tujuan -->
            <div class="flex-1">
                <label for="destinationDevice" class="block text-sm font-medium text-gray-700">Perangkat Tujuan:</label>
                <select id="destinationDevice" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="PC2">PC 2 (192.168.1.2)</option>
                    <option value="PC1">PC 1 (192.168.1.1)</option>
                    <option value="PC3">PC 3 (192.168.1.3)</option>
                </select>
            </div>
        </div>

        <!-- Tombol Kirim -->
        <button id="sendButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed" onclick="startSimulation()">
            Kirim Paket Data (PING!)
        </button>
    </div>

    <script>
        const canvas = document.getElementById('networkCanvas');
        const ctx = canvas.getContext('2d');
        const messageBox = document.getElementById('message-box');
        const sendButton = document.getElementById('sendButton');

        // Konstanta Jaringan
        const CANVAS_SIZE = 360;
        const SWITCH_POS = { x: CANVAS_SIZE / 2, y: CANVAS_SIZE / 2 };
        const DEVICE_RADIUS = 20;
        const PACKET_RADIUS = 5;

        // Mendefinisikan Perangkat dalam Jaringan (Topologi Star)
        const devices = [
            { id: 'PC1', ip: '192.168.1.1', mac: 'AA:BB:CC:DD:EE:01', color: '#10b981', angle: -Math.PI / 2, pos: {} }, // Atas
            { id: 'PC2', ip: '192.168.1.2', mac: 'AA:BB:CC:DD:EE:02', color: '#f59e0b', angle: Math.PI * 0.1, pos: {} }, // Kanan Atas
            { id: 'PC3', ip: '192.168.1.3', mac: 'AA:BB:CC:DD:EE:03', color: '#ef4444', angle: Math.PI * 0.75, pos: {} }, // Kiri Bawah
        ];

        // Struktur Tabel MAC Address pada Switch (Untuk demo pembelajaran)
        let macTable = {}; // macTable = { 'AA:BB:CC:DD:EE:01': { port: 1, ip: '192.168.1.1' }, ... }

        // Variabel Animasi Paket
        let packet = null;
        let animationFrameId = null;
        let isSimulating = false;

        // --- Fungsi Utilitas Matematika ---
        function getDevicePosition(device) {
            // Menghitung posisi perangkat dalam lingkaran di sekitar switch
            const radius = CANVAS_SIZE * 0.4;
            return {
                x: SWITCH_POS.x + radius * Math.cos(device.angle),
                y: SWITCH_POS.y + radius * Math.sin(device.angle)
            };
        }

        // --- Inisialisasi ---
        function initializeNetwork() {
            // Hitung dan simpan posisi permanen perangkat
            devices.forEach(device => {
                device.pos = getDevicePosition(device);
            });
            drawNetwork();
            updateMessage("Jaringan berhasil diinisialisasi. Siap mengirim paket.");
        }

        // --- Fungsi Menggambar ---
        function drawNetwork() {
            ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            // 1. Gambar Switch (Pusat)
            ctx.fillStyle = '#3b82f6';
            ctx.beginPath();
            ctx.arc(SWITCH_POS.x, SWITCH_POS.y, DEVICE_RADIUS + 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 10px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('SWITCH', SWITCH_POS.x, SWITCH_POS.y);

            // 2. Gambar Kabel dan Perangkat
            devices.forEach((device, index) => {
                const pos = device.pos;

                // Gambar Kabel (Garis antara Switch dan Perangkat)
                ctx.strokeStyle = '#9ca3af';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(SWITCH_POS.x, SWITCH_POS.y);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();

                // Gambar Perangkat (PC)
                ctx.fillStyle = device.color;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, DEVICE_RADIUS, 0, Math.PI * 2);
                ctx.fill();

                // Teks ID Perangkat
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 12px Inter';
                ctx.fillText(device.id, pos.x, pos.y - DEVICE_RADIUS - 5);
                ctx.font = '10px Inter';
                ctx.fillText(device.ip, pos.x, pos.y + DEVICE_RADIUS + 10);

                // Teks Koneksi ke Switch (Port)
                ctx.fillStyle = '#1f2937';
                ctx.font = '10px Inter';
                const midX = (SWITCH_POS.x + pos.x) / 2;
                const midY = (SWITCH_POS.y + pos.y) / 2;
                ctx.fillText(`Port ${index + 1}`, midX + 15, midY);
            });
        }

        // --- Fungsi Animasi Paket ---
        function createPacket(source, destination) {
            const startPos = source.pos;
            return {
                x: startPos.x,
                y: startPos.y,
                source: source,
                destination: destination,
                step: 0, // 0: Menuju Switch, 1: Memproses, 2: Menuju Tujuan, 3: Selesai
                totalDistanceToSwitch: Math.hypot(SWITCH_POS.x - startPos.x, SWITCH_POS.y - startPos.y),
                totalDistanceToDest: Math.hypot(destination.pos.x - SWITCH_POS.x, destination.pos.y - SWITCH_POS.y),
                progress: 0, // 0.0 sampai 1.0
                speed: 0.015, // Kecepatan Animasi
                color: source.color,
                isBroadcast: false,
            };
        }

        function animate() {
            if (!packet) {
                isSimulating = false;
                return;
            }

            drawNetwork(); // Gambar ulang jaringan statis

            // Update posisi paket
            packet.progress += packet.speed;

            let currentX = packet.x;
            let currentY = packet.y;

            if (packet.step === 0) {
                // Tahap 0: Dari Perangkat Asal ke Switch
                if (packet.progress < 1) {
                    currentX = packet.source.pos.x + (SWITCH_POS.x - packet.source.pos.x) * packet.progress;
                    currentY = packet.source.pos.y + (SWITCH_POS.y - packet.source.pos.y) * packet.progress;
                    updateMessage(`[${packet.source.id}] Mengirim paket ke Switch...`);
                } else {
                    // Sampai di Switch
                    packet.step = 1;
                    packet.progress = 0;
                }
            } else if (packet.step === 1) {
                // Tahap 1: Switch Memproses (Jeda Singkat)
                if (packet.progress < 0.2) { // Jeda 0.2 unit waktu
                    currentX = SWITCH_POS.x;
                    currentY = SWITCH_POS.y;
                    
                    if (packet.progress < 0.01) {
                        // Logika Pembelajaran MAC Address (Hanya dijalankan sekali)
                        if (!macTable[packet.source.mac]) {
                            const sourcePort = devices.findIndex(d => d.id === packet.source.id) + 1;
                            macTable[packet.source.mac] = { port: sourcePort, ip: packet.source.ip };
                            console.log(`MAC Table Update: ${packet.source.mac} (Port ${sourcePort})`);
                            updateMessage(`Switch mempelajari alamat MAC ${packet.source.mac} dari ${packet.source.id}.`);
                        }
                    }

                    // Logika Forwarding Switch
                    if (macTable[packet.destination.mac]) {
                        // UNICAST: Tujuan ada di MAC Table
                        updateMessage(`Switch melakukan UNICAST ke ${packet.destination.id} (Tujuan ditemukan).`);
                    } else {
                        // BROADCAST: Tujuan belum ada di MAC Table
                        packet.isBroadcast = true;
                        updateMessage(`Switch melakukan BROADCAST! Tujuan ${packet.destination.id} tidak ditemukan.`);
                    }

                } else {
                    // Mulai kirim ke tujuan
                    packet.step = 2;
                    packet.progress = 0;
                }
            } else if (packet.step === 2) {
                // Tahap 2: Dari Switch ke Tujuan
                if (packet.progress < 1) {
                    currentX = SWITCH_POS.x + (packet.destination.pos.x - SWITCH_POS.x) * packet.progress;
                    currentY = SWITCH_POS.y + (packet.destination.pos.y - SWITCH_POS.y) * packet.progress;

                    if (packet.isBroadcast) {
                        // Jika broadcast, gambarkan juga paket ke perangkat lain (Sederhana)
                        devices.forEach(device => {
                            if (device.id !== packet.source.id && device.id !== packet.destination.id) {
                                // Gambar paket 'Ditolak' ke perangkat lain
                                const x_reject = SWITCH_POS.x + (device.pos.x - SWITCH_POS.x) * packet.progress;
                                const y_reject = SWITCH_POS.y + (device.pos.y - SWITCH_POS.y) * packet.progress;
                                drawPacket(x_reject, y_reject, '#fef3c7', 'X'); // Kuning muda
                            }
                        });
                        updateMessage(`BROADCAST! ${packet.destination.id} menerima, yang lain menolak.`);
                    } else {
                         updateMessage(`UNICAST! Paket diteruskan langsung ke ${packet.destination.id}.`);
                    }

                } else {
                    // Sampai di Tujuan
                    packet.step = 3;
                    packet.progress = 0;
                }
            } else if (packet.step === 3) {
                // Tahap 3: Selesai (Jeda)
                currentX = packet.destination.pos.x;
                currentY = packet.destination.pos.y;
                updateMessage(`Paket berhasil diterima oleh ${packet.destination.id}!`);

                if (packet.progress < 0.5) {
                    packet.progress += 0.01;
                } else {
                    // Selesai Animasi
                    packet = null;
                    isSimulating = false;
                    sendButton.disabled = false;
                    updateMessage("Simulasi selesai. Kirim paket lagi.");

                    // Perbarui MAC Table di console untuk referensi
                    console.log("MAC Table saat ini:", macTable);
                }
            }
            
            // Gambar Paket di posisi terbaru
            drawPacket(currentX, currentY, packet.color);

            // Loop Animasi
            animationFrameId = requestAnimationFrame(animate);
        }

        function drawPacket(x, y, color, text = 'P') {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, PACKET_RADIUS, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 8px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }

        function updateMessage(message) {
            messageBox.textContent = message;
        }

        // --- Fungsi Pemicu Utama ---
        function startSimulation() {
            if (isSimulating) return;

            const sourceId = document.getElementById('sourceDevice').value;
            const destId = document.getElementById('destinationDevice').value;

            if (sourceId === destId) {
                updateMessage("Kesalahan: Perangkat asal dan tujuan tidak boleh sama!");
                return;
            }

            const source = devices.find(d => d.id === sourceId);
            const destination = devices.find(d => d.id === destId);

            if (!source || !destination) return;

            isSimulating = true;
            sendButton.disabled = true;

            // Batalkan frame sebelumnya jika ada
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }

            // Buat paket baru dan mulai animasi
            packet = createPacket(source, destination);
            animate();
        }

        // Pastikan kode dijalankan setelah DOM dimuat
        window.onload = initializeNetwork;

    </script>
</body>
</html>